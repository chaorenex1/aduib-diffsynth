# å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“ æ¦‚è¿°

å·²æˆåŠŸä¸º Text-to-Image API æ·»åŠ å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½å…è®¸ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡æˆ–æŒ‡å®šå›¾ç‰‡è·¯å¾„ï¼Œå¹¶ä½¿ç”¨ AI æ¨¡å‹æ ¹æ®æ–‡æœ¬æç¤ºè¯å¯¹å›¾ç‰‡è¿›è¡Œç¼–è¾‘ã€‚

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. API æ¥å£

åœ¨ `controllers/text_to_image.py` ä¸­æ–°å¢äº†ä»¥ä¸‹æ¥å£ï¼š

#### `/text-to-image/edit` (POST)
- **åŠŸèƒ½**: ä¸Šä¼ å›¾ç‰‡è¿›è¡Œç¼–è¾‘
- **è¯·æ±‚ç±»å‹**: multipart/form-data
- **å‚æ•°**: 
  - `input_image`: ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ (å¿…å¡«)
  - `prompt`: ç¼–è¾‘æç¤ºè¯ (å¿…å¡«)
  - `negative_prompt`: è´Ÿå‘æç¤ºè¯ (å¯é€‰)
  - `model_type`: æ¨¡å‹ç±»å‹ (é»˜è®¤: Qwen-Image-Edit-2509)
  - `width`, `height`: å›¾åƒå°ºå¯¸ (é»˜è®¤: 1024x1024)
  - `num_inference_steps`: æ¨ç†æ­¥æ•° (é»˜è®¤: 50)
  - `guidance_scale`: å¼•å¯¼ç³»æ•° (é»˜è®¤: 4.5)
  - `seed`: éšæœºç§å­ (å¯é€‰)
  - `lora_model`: LoRAæ¨¡å‹ (å¯é€‰)
  - `offload_model`: æ˜¯å¦å¸è½½æ¨¡å‹èŠ‚çœæ˜¾å­˜ (é»˜è®¤: false)

#### `/text-to-image/edit-by-path` (POST)
- **åŠŸèƒ½**: é€šè¿‡æœåŠ¡å™¨è·¯å¾„ç¼–è¾‘å›¾ç‰‡
- **è¯·æ±‚ç±»å‹**: application/json
- **å‚æ•°**: 
  - `input_image_path`: è¾“å…¥å›¾ç‰‡çš„æœåŠ¡å™¨è·¯å¾„ (å¿…å¡«)
  - å…¶ä»–å‚æ•°ä¸ `/edit` æ¥å£ç›¸åŒ

### 2. æ•°æ®æ¨¡å‹

æ–°å¢äº†ä»¥ä¸‹ Pydantic æ¨¡å‹ï¼š

- `ImageEditRequest`: å›¾ç‰‡ç¼–è¾‘è¯·æ±‚å‚æ•°æ¨¡å‹
- `ImageEditResponse`: å›¾ç‰‡ç¼–è¾‘å“åº”æ¨¡å‹
- `ImageEditByPathRequest`: è·¯å¾„ç¼–è¾‘è¯·æ±‚å‚æ•°æ¨¡å‹

### 3. æ ¸å¿ƒåŠŸèƒ½

- âœ… æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼ (JPEG, PNG, BMP, WebP)
- âœ… è‡ªåŠ¨è°ƒæ•´å›¾ç‰‡å°ºå¯¸
- âœ… ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºè·¯å¾„
- âœ… é›†æˆç°æœ‰çš„æ¨¡å‹ç®¡ç†ç³»ç»Ÿ
- âœ… æ”¯æŒ LoRA æ¨¡å‹å¾®è°ƒ
- âœ… æ”¯æŒä½æ˜¾å­˜æ¨¡å¼

## ğŸ“ æ–‡ä»¶å˜æ›´

### ä¿®æ”¹çš„æ–‡ä»¶
- `controllers/text_to_image.py`: æ·»åŠ å›¾ç‰‡ç¼–è¾‘æ¥å£

### æ–°å¢çš„æ–‡ä»¶
- `docs/IMAGE_EDITING_API.md`: å›¾ç‰‡ç¼–è¾‘APIå®Œæ•´æ–‡æ¡£
- `test/test_image_editing_api.py`: APIæµ‹è¯•è„šæœ¬

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨ Python requests

```python
import requests

# ä¸Šä¼ å›¾ç‰‡ç¼–è¾‘
url = "http://localhost:8000/text-to-image/edit"
files = {'input_image': open('image.jpg', 'rb')}
data = {
    'prompt': 'æŠŠå¤©ç©ºå˜æˆæ—¥è½çš„é¢œè‰²',
    'width': 1024,
    'height': 1024,
    'num_inference_steps': 50
}
response = requests.post(url, files=files, data=data)
result = response.json()
print(f"ç¼–è¾‘åçš„å›¾ç‰‡: {result['image_path']}")
```

### æ–¹æ³•2: ä½¿ç”¨ cURL

```bash
curl -X POST "http://localhost:8000/text-to-image/edit" \
  -H "Content-Type: multipart/form-data" \
  -F "input_image=@image.jpg" \
  -F "prompt=æŠŠå¤©ç©ºå˜æˆæ—¥è½çš„é¢œè‰²" \
  -F "width=1024" \
  -F "height=1024"
```

### æ–¹æ³•3: é€šè¿‡è·¯å¾„ç¼–è¾‘

```python
import requests

url = "http://localhost:8000/text-to-image/edit-by-path"
payload = {
    "input_image_path": "/path/to/image.jpg",
    "prompt": "æ·»åŠ æ¢¦å¹»å…‰æ–‘æ•ˆæœ",
    "width": 1024,
    "height": 1024
}
response = requests.post(url, json=payload)
result = response.json()
```

### æ–¹æ³•4: è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
# å‡†å¤‡æµ‹è¯•å›¾ç‰‡
cp your_image.jpg test_image.jpg

# è¿è¡Œæµ‹è¯•
python test/test_image_editing_api.py
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¾èµ–å…³ç³»

å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ä¾èµ–äºï¼š
- `diffsynths/text_to_image.py` ä¸­çš„ `edit_image()` å‡½æ•°
- FastAPI çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ (UploadFile, File, Form)
- PIL/Pillow å›¾åƒå¤„ç†åº“

### å·¥ä½œæµç¨‹

1. **æ¥æ”¶è¯·æ±‚**: API æ¥æ”¶ä¸Šä¼ çš„å›¾ç‰‡æˆ–å›¾ç‰‡è·¯å¾„
2. **ä¸´æ—¶å­˜å‚¨**: ä¸Šä¼ çš„å›¾ç‰‡ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
3. **æ¨¡å‹åŠ è½½**: å¦‚éœ€è¦ï¼ŒåŠ è½½æˆ–åˆ‡æ¢å›¾åƒç¼–è¾‘æ¨¡å‹
4. **å›¾åƒå¤„ç†**: è°ƒæ•´å›¾ç‰‡å°ºå¯¸è‡³ç›®æ ‡åˆ†è¾¨ç‡
5. **AIç¼–è¾‘**: ä½¿ç”¨æ¨¡å‹å’Œæç¤ºè¯ç¼–è¾‘å›¾ç‰‡
6. **ä¿å­˜ç»“æœ**: å°†ç¼–è¾‘åçš„å›¾ç‰‡ä¿å­˜åˆ°è¾“å‡ºç›®å½•
7. **æ¸…ç†èµ„æº**: åˆ é™¤ä¸´æ—¶æ–‡ä»¶
8. **è¿”å›ç»“æœ**: è¿”å›ç¼–è¾‘åå›¾ç‰‡çš„è·¯å¾„

### è¾“å‡ºç›®å½•

- é»˜è®¤è¾“å‡ºç›®å½•: `outputs/image_edit/`
- æ–‡ä»¶å‘½å: UUID.png (å¦‚ `12345678-1234-5678-1234-567812345678.png`)
- å¯é€šè¿‡ `output_path` å‚æ•°è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„

## ğŸ“š æ–‡æ¡£

- **å®Œæ•´APIæ–‡æ¡£**: [docs/IMAGE_EDITING_API.md](docs/IMAGE_EDITING_API.md)
- **äº¤äº’å¼æ–‡æ¡£**: http://localhost:8000/docs (å¯åŠ¨æœåŠ¡åè®¿é—®)
- **åŸæœ‰åŠŸèƒ½æ–‡æ¡£**: [docs/IMAGE_EDITING_FEATURE.md](docs/IMAGE_EDITING_FEATURE.md)

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```bash
# ç¡®ä¿APIæœåŠ¡æ­£åœ¨è¿è¡Œ
python app.py &

# è¿è¡Œæµ‹è¯•
python test/test_image_editing_api.py
```

## âš™ï¸ é…ç½®å»ºè®®

### æ˜¾å­˜ä¼˜åŒ–
- æ˜¾å­˜å……è¶³: `offload_model=false`
- æ˜¾å­˜ä¸è¶³ (<8GB): `offload_model=true`

### é€Ÿåº¦ä¸è´¨é‡å¹³è¡¡
- å¿«é€Ÿé¢„è§ˆ: `num_inference_steps=20-30`
- æ ‡å‡†è´¨é‡: `num_inference_steps=50` (æ¨è)
- æœ€é«˜è´¨é‡: `num_inference_steps=80-100`

### å¼•å¯¼ç³»æ•°è°ƒæ•´
- è‡ªç„¶æ•ˆæœ: `guidance_scale=3.0-4.5`
- æ ‡å‡†æ•ˆæœ: `guidance_scale=4.5-6.0`
- å¼ºçƒˆæ•ˆæœ: `guidance_scale=6.0-8.0`

## ğŸ”„ ä¸ç°æœ‰åŠŸèƒ½çš„é›†æˆ

å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½å®Œå…¨é›†æˆåˆ°ç°æœ‰çš„ Text-to-Image API ä¸­ï¼š

- âœ… å…±äº«æ¨¡å‹ç®¡ç†ç³»ç»Ÿ
- âœ… ä½¿ç”¨ç›¸åŒçš„è·¯ç”±å‰ç¼€ `/text-to-image`
- âœ… å…¼å®¹ç°æœ‰çš„åŠ è½½/å¸è½½æ¨¡å‹æ¥å£
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… ä¸€è‡´çš„å“åº”æ ¼å¼

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œ**: é¦–æ¬¡ä½¿ç”¨ä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´å’Œè¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
2. **æ˜¾å­˜éœ€æ±‚**: å›¾ç‰‡ç¼–è¾‘é€šå¸¸æ¯”æ–‡ç”Ÿå›¾éœ€è¦æ›´å¤šæ˜¾å­˜ï¼Œå»ºè®®è‡³å°‘ 8GB
3. **å›¾ç‰‡æ ¼å¼**: è¾“å…¥æ”¯æŒå¤šç§æ ¼å¼ï¼Œè¾“å‡ºå›ºå®šä¸º PNG æ ¼å¼
4. **æ–‡ä»¶å¤§å°**: ä¸Šä¼ çš„å›¾ç‰‡ä¼šè¢«è°ƒæ•´ä¸ºæŒ‡å®šå°ºå¯¸ï¼Œå»ºè®®ä¸è¶…è¿‡ 10MB
5. **å®‰å…¨æ€§**: ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ æ–‡ä»¶ç±»å‹éªŒè¯å’Œå¤§å°é™åˆ¶

## ğŸ¯ ä¸‹ä¸€æ­¥

å¯ä»¥è€ƒè™‘çš„æ‰©å±•åŠŸèƒ½ï¼š

- [ ] æ‰¹é‡å›¾ç‰‡ç¼–è¾‘æ¥å£
- [ ] å›¾ç‰‡å†å²è®°å½•ç®¡ç†
- [ ] ç¼–è¾‘è¿›åº¦æŸ¥è¯¢
- [ ] æ›´å¤šå›¾åƒç¼–è¾‘æ¨¡å‹æ”¯æŒ
- [ ] å›¾ç‰‡é¢„å¤„ç†é€‰é¡¹ï¼ˆæ»¤é•œã€è°ƒæ•´ç­‰ï¼‰
- [ ] WebSocket å®æ—¶é¢„è§ˆ
- [ ] å›¾ç‰‡ç¼–è¾‘æ¨¡æ¿ç³»ç»Ÿ

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- APIäº¤äº’å¼æ–‡æ¡£: http://localhost:8000/docs
- å®Œæ•´æ–‡æ¡£: docs/IMAGE_EDITING_API.md
- åŸæœ‰æ–‡æ¡£: docs/IMAGE_EDITING_FEATURE.md

---

**æ›´æ–°æ—¶é—´**: 2025-12-10
**ç‰ˆæœ¬**: v1.0.0

